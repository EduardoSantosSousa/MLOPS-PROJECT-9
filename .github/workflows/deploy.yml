name: MLOps Pipeline - Train and Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  RESOURCE_GROUP: MLOps_Projects
  APP_SERVICE_NAME: mlops-project-nine-webapp
  ACR_NAME: mlopsprojectnine
  IMAGE_NAME: mlops-project-nine
  DOCKERFILE_PATH: .

jobs:
  train-model:
    name: Train and Save Model
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install -e .
        
    - name: Run Training Pipeline
      env:
        CONNECTION_STRING: ${{ secrets.CONNECTION_STRING }}
        CONTAINER_NAME: ${{ secrets.CONTAINER_NAME }}
        BLOB_NAME: ${{ secrets.BLOB_NAME }}
      run: |
        python pipeline/training_pipeline.py
        
    - name: Verify Model File
      run: |
        ls -la model/
        if [ -f "models/model.pkl" ]; then
          echo "✅ Model file exists"
        else
          echo "❌ Model file not found!"
          exit 1
        fi
        
    - name: Upload Trained Model
      uses: actions/upload-artifact@v4
      with:
        name: trained-model
        path: |
          ${{ github.workspace }}/models/model.pkl
          ${{ github.workspace }}/config/paths_config.py
        retention-days: 1

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: train-model
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download Model Artifact
      uses: actions/download-artifact@v4
      with:
        name: trained-model
        path: artifact-download

    - name: Debug - List downloaded files
      run: ls -R artifact-download 

    - name: Move Files to Correct Location
      run: |
        # Verifica e move o modelo
        if [ -f "artifact-download/model.pkl" ]; then
          mkdir -p model
          mv artifact-download/model.pkl model/
        else
          echo "⚠️ model.joblib not found in artifact!"
        fi

        # Verifica e move o arquivo de configuração
        if [ -f "artifact-download/paths_config.py" ]; then
          mkdir -p config
          mv artifact-download/paths_config.py config/
        elif [ -f "artifact-download/config/paths_config.py" ]; then
          mkdir -p config
          mv artifact-download/config/paths_config.py config/
        else
          echo "⚠️ paths_config.py not found in artifact!"
        fi
        
        rm -rf artifact-download

    - name: Login to Azure Container Registry
      uses: azure/docker-login@v2
      with:
        login-server: ${{ env.ACR_NAME }}.azurecr.io
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ${{ env.DOCKERFILE_PATH }}
        push: true
        tags: |
          ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy to Azure App Service
      run: |
        az webapp config container set \
          --name ${{ env.APP_SERVICE_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --docker-custom-image-name ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}

    - name: Update App Settings
      run: |
        az webapp config appsettings set \
          --name ${{ env.APP_SERVICE_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --settings \
            BLOB_NAME="${{ secrets.BLOB_NAME }}" \
            CONTAINER_NAME="${{ secrets.CONTAINER_NAME }}" \
            CONNECTION_STRING="${{ secrets.CONNECTION_STRING }}"

    - name: Restart App Service
      run: |
        az webapp restart --name ${{ env.APP_SERVICE_NAME }} --resource-group ${{ env.RESOURCE_GROUP }}